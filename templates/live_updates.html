{% extends "base.html" %}
{% block content %}

<style>
/* ===== LIVE UPDATES PAGE ===== */
.live-updates-title {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 20px;
    color: #ff4d4d;
    display: flex;
    align-items: center;
    gap: 12px;
}

.refresh-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 15px;
    background: rgba(255,77,77,0.1);
    border-radius: 14px;
    border: 1px solid rgba(255,77,77,0.3);
}

.refresh-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.live-dot-large {
    width: 12px;
    height: 12px;
    background: #ff4d4d;
    border-radius: 50%;
    animation: pulse 1.2s infinite;
}

.refresh-btn-large {
    background: linear-gradient(135deg, #ff4d4d, #cc0000);
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s;
}

.refresh-btn-large:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(255, 77, 77, 0.3);
}

.refresh-btn-large:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.live-matches-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.live-match-card {
    background: linear-gradient(145deg, #1a0f0f, #271414);
    border-radius: 16px;
    padding: 20px;
    border: 2px solid #ff4d4d;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
    animation: pulseBorder 2s infinite;
}

@keyframes pulseBorder {
    0%, 100% { border-color: #ff4d4d; }
    50% { border-color: #ff9999; }
}

.live-match-card::before {
    content: 'LIVE';
    position: absolute;
    top: 10px;
    right: 10px;
    background: #ff4d4d;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 800;
    z-index: 10;
}

.match-header-live {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.competition-live {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #00ffcc;
}

.match-minute-live {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #ff4d4d;
    font-weight: 700;
}

.minute-dot {
    width: 8px;
    height: 8px;
    background: #ff4d4d;
    border-radius: 50%;
    animation: pulse 1s infinite;
}

.match-teams-live {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 20px;
}

.team-live {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 40%;
}

.team-crest-live {
    width: 50px;
    height: 50px;
    object-fit: contain;
}

.team-info-live {
    flex: 1;
}

.team-name-live {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.team-short-live {
    font-size: 0.9rem;
    opacity: 0.8;
}

.score-live {
    font-size: 2.5rem;
    font-weight: 800;
    background: rgba(0,0,0,0.5);
    padding: 10px 20px;
    border-radius: 12px;
    color: #ff4d4d;
    min-width: 140px;
    text-align: center;
}

.match-events-live {
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
}

.events-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #00ffcc;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.event-item-live {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.event-minute {
    min-width: 40px;
    font-weight: 700;
    color: #ff4d4d;
    font-size: 0.9rem;
}

.event-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

.event-details-live {
    flex: 1;
    font-size: 0.9rem;
}

.event-player {
    font-weight: 600;
}

.event-type {
    font-size: 0.8rem;
    opacity: 0.8;
}

.match-stats-live {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

.stat-item-live {
    text-align: center;
    padding: 12px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
}

.stat-value-live {
    font-size: 1.5rem;
    font-weight: 800;
    color: #00ffcc;
    margin-bottom: 5px;
}

.stat-label-live {
    font-size: 0.8rem;
    opacity: 0.8;
    text-transform: uppercase;
}

.no-live-matches {
    text-align: center;
    padding: 60px 20px;
    opacity: 0.6;
}

.no-live-matches i {
    font-size: 4rem;
    margin-bottom: 20px;
    display: block;
    color: #ff4d4d;
}

.no-live-matches h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.no-live-matches p {
    font-size: 1rem;
    opacity: 0.8;
}

.view-match-btn {
    background: linear-gradient(135deg, #00ffcc, #00a388);
    border: none;
    border-radius: 12px;
    padding: 12px 24px;
    color: #000;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 20px auto 0;
    transition: all 0.2s;
}

.view-match-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 204, 0.3);
}

/* Auto refresh toggle */
.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
}

.switch-container {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.switch-small {
    position: relative;
    display: inline-block;
    width: 46px;
    height: 24px;
}

.switch-small input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider-small {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #333;
    transition: .4s;
    border-radius: 24px;
}

.slider-small:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider-small {
    background-color: #ff4d4d;
}

input:checked + .slider-small:before {
    transform: translateX(22px);
}

/* Match notifications */
.match-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ff4d4d, #cc0000);
    color: white;
    padding: 15px 20px;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideUp 0.3s ease;
    max-width: 300px;
    display: none;
}

@keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.match-notification.show {
    display: block;
}

.notification-match {
    font-weight: 700;
    margin-bottom: 5px;
}

.notification-event {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Responsive */
@media (max-width: 768px) {
    .match-teams-live {
        flex-direction: column;
        gap: 15px;
    }
    
    .team-live {
        width: 100%;
        justify-content: center;
    }
    
    .score-live {
        order: -1;
        width: 100%;
    }
    
    .refresh-container {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .refresh-info {
        justify-content: center;
    }
}
</style>

<div class="live-updates-title">
    <i class="bi bi-broadcast"></i> Live Match Updates
</div>

<!-- Refresh Control -->
<div class="refresh-container">
    <div class="refresh-info">
        <div class="live-dot-large"></div>
        <div>
            <div style="font-weight: 700;">Live Updates Active</div>
            <div style="font-size: 0.9rem; opacity: 0.8;">Auto-refreshing every 30 seconds</div>
        </div>
    </div>
    
    <div class="auto-refresh-toggle">
        <div class="switch-container">
            <span style="margin-right: 10px;">Auto Refresh:</span>
            <label class="switch-small">
                <input type="checkbox" id="autoRefreshToggle" checked>
                <span class="slider-small"></span>
            </label>
        </div>
        
        <button class="refresh-btn-large" onclick="refreshLiveData()" id="refreshLiveBtn">
            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i>
            Refresh Now
        </button>
    </div>
</div>

<!-- Live Matches -->
<div class="live-matches-container" id="liveMatchesContainer">
    {% if matches %}
        {% for match in matches %}
        <div class="live-match-card" id="match-{{ match.id }}">
            <div class="match-header-live">
                <div class="competition-live">
                    {% if match.competition and match.competition.emblem %}
                    <img src="{{ match.competition.emblem }}" style="width: 24px; height: 24px;">
                    {% endif %}
                    <span>{{ match.competition.name if match.competition else 'Unknown Competition' }}</span>
                </div>
                
                <div class="match-minute-live">
                    <div class="minute-dot"></div>
                    <span>{{ match.minute if match.minute else 'LIVE' }}'</span>
                </div>
            </div>
            
            <div class="match-teams-live">
                <div class="team-live">
                    {% if match.homeTeam and match.homeTeam.crest %}
                    <img src="{{ match.homeTeam.crest }}" alt="{{ match.homeTeam.name }}" class="team-crest-live">
                    {% endif %}
                    
                    <div class="team-info-live">
                        <div class="team-name-live">{{ match.homeTeam.name if match.homeTeam else 'Home Team' }}</div>
                        {% if match.homeTeam and match.homeTeam.shortName %}
                        <div class="team-short-live">{{ match.homeTeam.shortName }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="score-live">
                    {{ match.score.fullTime.home if match.score and match.score.fullTime and match.score.fullTime.home is not none else '0' }} - 
                    {{ match.score.fullTime.away if match.score and match.score.fullTime and match.score.fullTime.away is not none else '0' }}
                </div>
                
                <div class="team-live" style="flex-direction: row-reverse; text-align: right;">
                    <div class="team-info-live">
                        <div class="team-name-live">{{ match.awayTeam.name if match.awayTeam else 'Away Team' }}</div>
                        {% if match.awayTeam and match.awayTeam.shortName %}
                        <div class="team-short-live">{{ match.awayTeam.shortName }}</div>
                        {% endif %}
                    </div>
                    
                    {% if match.awayTeam and match.awayTeam.crest %}
                    <img src="{{ match.awayTeam.crest }}" alt="{{ match.awayTeam.name }}" class="team-crest-live">
                    {% endif %}
                </div>
            </div>
            
            <!-- Events -->
            {% if match.details and match.details.events %}
            <div class="match-events-live">
                <div class="events-title">
                    <i class="bi bi-calendar-event"></i> Recent Events
                </div>
                
                {% for event in match.details.events[-5:]|reverse %}
                <div class="event-item-live">
                    <div class="event-minute">
                        {{ event.time.elapsed if event.time.elapsed else '?' }}'
                    </div>
                    
                    <div class="event-icon" style="background: {% if 'goal' in event.type|lower %}rgba(0,255,0,0.2){% elif 'yellow' in event.type|lower %}rgba(255,255,0,0.2){% elif 'red' in event.type|lower %}rgba(255,0,0,0.2){% else %}rgba(0,255,255,0.2){% endif %};">
                        {% if 'goal' in event.type|lower %}âš½{% elif 'yellow' in event.type|lower %}ðŸŸ¨{% elif 'red' in event.type|lower %}ðŸŸ¥{% else %}ðŸ”¹{% endif %}
                    </div>
                    
                    <div class="event-details-live">
                        <div class="event-player">
                            {{ event.player.name if event.player else 'Unknown' }}
                        </div>
                        <div class="event-type">
                            {{ event.type|replace('_', ' ')|title }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Statistics -->
            {% if match.details and match.details.statistics %}
            <div class="match-stats-live">
                {% for stat in match.details.statistics %}
                {% if stat.type in ['possession', 'total_shots', 'shots_on_target', 'corners'] %}
                <div class="stat-item-live">
                    <div class="stat-value-live">
                        {{ stat.homeTeam.value if stat.homeTeam.value is not none else 0 }}
                    </div>
                    <div class="stat-label-live">
                        {{ stat.type|replace('_', ' ')|title }}
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            
            <button class="view-match-btn" onclick="window.location.href='/match/{{ match.id }}'">
                <i class="bi bi-arrow-right"></i> View Full Match Details
            </button>
        </div>
        {% endfor %}
    {% else %}
    <div class="no-live-matches">
        <i class="bi bi-broadcast"></i>
        <h3>No Live Matches</h3>
        <p>There are currently no matches being played live.</p>
        <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
            <button class="view-match-btn" onclick="window.location.href='/'">
                <i class="bi bi-calendar-event"></i> Upcoming Matches
            </button>
            <button class="view-match-btn" onclick="window.location.href='/finished'" style="background: linear-gradient(135deg, #00aaff, #0066cc);">
                <i class="bi bi-flag"></i> Finished Matches
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Match Notification -->
<div class="match-notification" id="matchNotification">
    <div class="notification-match" id="notificationMatch"></div>
    <div class="notification-event" id="notificationEvent"></div>
</div>

<script>
// Global variables
let autoRefreshInterval = null;
let isAutoRefreshing = true;
let previousMatchesData = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Start auto refresh
    startAutoRefresh();
    
    // Store initial matches data for comparison
    storeMatchesData();
    
    // Setup auto refresh toggle
    document.getElementById('autoRefreshToggle').addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
});

// Auto refresh functions
function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    autoRefreshInterval = setInterval(refreshLiveData, 30000); // Every 30 seconds
    isAutoRefreshing = true;
    document.getElementById('autoRefreshToggle').checked = true;
    
    console.log('Auto-refresh started');
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    isAutoRefreshing = false;
    document.getElementById('autoRefreshToggle').checked = false;
    
    console.log('Auto-refresh stopped');
}

// Refresh live data
async function refreshLiveData() {
    const refreshBtn = document.getElementById('refreshLiveBtn');
    const refreshIcon = document.getElementById('refreshIcon');
    
    // Disable button and show loading
    refreshBtn.disabled = true;
    refreshIcon.style.animation = 'spin 1s linear infinite';
    
    try {
        const response = await fetch('/api/live/updates');
        const data = await response.json();
        
        // Update the matches display
        updateMatchesDisplay(data.matches);
        
        // Check for new events
        checkForNewEvents(data.matches);
        
        // Store new data for next comparison
        storeMatchesData(data.matches);
        
    } catch (error) {
        console.error('Failed to refresh live data:', error);
        showNotification('Failed to refresh live data', 'error');
    } finally {
        refreshBtn.disabled = false;
        refreshIcon.style.animation = '';
    }
}

// Store matches data for comparison
function storeMatchesData(matches = null) {
    if (!matches) {
        // Get current matches from DOM
        const matchElements = document.querySelectorAll('.live-match-card');
        const matchesData = [];
        
        matchElements.forEach(element => {
            const matchId = element.id.replace('match-', '');
            const score = element.querySelector('.score-live').textContent.trim();
            const minute = element.querySelector('.match-minute-live span').textContent.replace("'", "");
            
            matchesData.push({
                id: matchId,
                score: score,
                minute: minute
            });
        });
        
        previousMatchesData = matchesData;
    } else {
        // Store from API data
        previousMatchesData = matches.map(match => ({
            id: match.id,
            score: `${match.score.fullTime.home || 0}-${match.score.fullTime.away || 0}`,
            minute: match.minute || 'LIVE'
        }));
    }
}

// Update matches display
function updateMatchesDisplay(matches) {
    const container = document.getElementById('liveMatchesContainer');
    
    if (matches.length === 0) {
        container.innerHTML = `
            <div class="no-live-matches">
                <i class="bi bi-broadcast"></i>
                <h3>No Live Matches</h3>
                <p>There are currently no matches being played live.</p>
            </div>
        `;
        return;
    }
    
    // Update each match
    matches.forEach(match => {
        const matchElement = document.getElementById(`match-${match.id}`);
        if (matchElement) {
            // Update score
            const scoreElement = matchElement.querySelector('.score-live');
            if (scoreElement) {
                scoreElement.textContent = `${match.score.fullTime.home || 0}-${match.score.fullTime.away || 0}`;
            }
            
            // Update minute
            const minuteElement = matchElement.querySelector('.match-minute-live span');
            if (minuteElement) {
                minuteElement.textContent = match.minute ? `${match.minute}'` : 'LIVE';
            }
            
            // Update events if available
            if (match.details && match.details.events) {
                updateMatchEvents(matchElement, match.details.events);
            }
        }
    });
}

// Update match events
function updateMatchEvents(matchElement, events) {
    const eventsContainer = matchElement.querySelector('.match-events-live');
    if (!eventsContainer) return;
    
    // Clear existing events except title
    const eventsTitle = eventsContainer.querySelector('.events-title');
    eventsContainer.innerHTML = '';
    if (eventsTitle) {
        eventsContainer.appendChild(eventsTitle);
    }
    
    // Add recent events (last 5)
    const recentEvents = events.slice(-5).reverse();
    
    recentEvents.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item-live';
        
        const eventType = event.type.toLowerCase();
        let eventIcon = 'ðŸ”¹';
        let iconColor = 'rgba(0,255,255,0.2)';
        
        if (eventType.includes('goal')) {
            eventIcon = 'âš½';
            iconColor = 'rgba(0,255,0,0.2)';
        } else if (eventType.includes('yellow')) {
            eventIcon = 'ðŸŸ¨';
            iconColor = 'rgba(255,255,0,0.2)';
        } else if (eventType.includes('red')) {
            eventIcon = 'ðŸŸ¥';
            iconColor = 'rgba(255,0,0,0.2)';
        }
        
        eventItem.innerHTML = `
            <div class="event-minute">
                ${event.time.elapsed || '?'}'
            </div>
            <div class="event-icon" style="background: ${iconColor};">
                ${eventIcon}
            </div>
            <div class="event-details-live">
                <div class="event-player">
                    ${event.player ? event.player.name : 'Unknown'}
                </div>
                <div class="event-type">
                    ${event.type.replace('_', ' ').toUpperCase()}
                </div>
            </div>
        `;
        
        eventsContainer.appendChild(eventItem);
    });
}

// Check for new events and show notifications
function checkForNewEvents(newMatches) {
    if (!previousMatchesData) return;
    
    newMatches.forEach(newMatch => {
        const previousMatch = previousMatchesData.find(m => m.id === newMatch.id.toString());
        
        if (previousMatch) {
            // Check for score changes
            const newScore = `${newMatch.score.fullTime.home || 0}-${newMatch.score.fullTime.away || 0}`;
            if (previousMatch.score !== newScore) {
                showGoalNotification(newMatch, newScore, previousMatch.score);
            }
            
            // Check for minute updates (game progressing)
            const newMinute = newMatch.minute || 'LIVE';
            if (previousMatch.minute !== newMinute) {
                console.log(`Match ${newMatch.id} minute updated: ${previousMatch.minute} -> ${newMinute}`);
            }
        }
    });
}

// Show goal notification
function showGoalNotification(match, newScore, oldScore) {
    const notification = document.getElementById('matchNotification');
    const matchName = document.getElementById('notificationMatch');
    const eventText = document.getElementById('notificationEvent');
    
    // Parse scores
    const [newHome, newAway] = newScore.split('-').map(Number);
    const [oldHome, oldAway] = oldScore.split('-').map(Number);
    
    // Determine which team scored
    let scoringTeam = '';
    if (newHome > oldHome) {
        scoringTeam = match.homeTeam.name;
    } else if (newAway > oldAway) {
        scoringTeam = match.awayTeam.name;
    }
    
    matchName.textContent = `${match.homeTeam.name} vs ${match.awayTeam.name}`;
    eventText.textContent = `âš½ GOAL! ${scoringTeam} scores! ${newScore}`;
    
    // Show notification
    notification.classList.add('show');
    
    // Hide after 5 seconds
    setTimeout(() => {
        notification.classList.remove('show');
    }, 5000);
    
    // Play notification sound if enabled
    if (Notification.permission === 'granted') {
        new Notification('Goal!', {
            body: `${scoringTeam} scores! ${match.homeTeam.name} ${newScore} ${match.awayTeam.name}`,
            icon: match.competition?.emblem || '/static/favicon.ico'
        });
    }
}

// Show notification
function showNotification(message, type = 'info') {
    alert(message); // Simplified for now
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Add CSS for spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // R to refresh
    if (e.key === 'r' || e.key === 'R') {
        if (!e.ctrlKey) {
            e.preventDefault();
            refreshLiveData();
        }
    }
    
    // Space to toggle auto-refresh
    if (e.key === ' ') {
        e.preventDefault();
        const toggle = document.getElementById('autoRefreshToggle');
        toggle.checked = !toggle.checked;
        toggle.dispatchEvent(new Event('change'));
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>

{% endblock %}